name: Update NBA Standings

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-standings:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch NBA Standings
        id: fetch
        run: |
          cat > /tmp/update_standings.js << 'EOF'
          const fs = require('fs');
          const path = require('path');

          async function fetchStandings() {
            try {
              const apiKey = '${{ secrets.SPORTS_API_KEY }}';
              const nbaId = 4; // NBA sport ID

              const response = await fetch(
                `https://api.apilayer.com/therundown/sports/${nbaId}/teams`,
                {
                  method: 'GET',
                  headers: {
                    'apikey': apiKey,
                  },
                }
              );

              if (!response.ok) {
                throw new Error('Failed to fetch NBA standings');
              }

              const teamsData = await response.json();
              const standings = {};

              if (teamsData.teams && Array.isArray(teamsData.teams)) {
                teamsData.teams.forEach((team) => {
                  const teamAbbr = team.abbreviation?.toUpperCase();
                  const recordString = team.record;
                  if (recordString && typeof recordString === 'string') {
                    const wins = parseInt(recordString.split('-')[0]);
                    if (teamAbbr && !isNaN(wins)) {
                      standings[teamAbbr] = wins;
                    }
                  }
                });
              }

              const data = {
                lastUpdated: new Date().toISOString(),
                standings: standings
              };

              const standingsPath = path.join(__dirname, '..', 'public', 'standings.json');
              fs.writeFileSync(standingsPath, JSON.stringify(data, null, 2));
              console.log('Standings updated successfully');
              return true;
            } catch (error) {
              console.error('Error fetching standings:', error);
              return false;
            }
          }

          fetchStandings().then(success => {
            process.exit(success ? 0 : 1);
          });
          EOF
          
          node /tmp/update_standings.js

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/standings.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update NBA standings" && git push)
